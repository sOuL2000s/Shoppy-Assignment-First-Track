
--- START FILE: README.md ---

# ðŸš€ Shoppy V2: Production-Grade E-commerce Platform

## Project Overview

Shoppy V2 is a demonstration of a secure, scalable, full-stack e-commerce system developed as a coding assessment project. It supports role-based access control (Customer and Seller) and leverages advanced caching techniques (Redis) for performance, and transactional integrity (MySQL/Sequelize) for financial operations (Checkout).

## ðŸ› ï¸ Tech Stack

| Component | Technology | Rationale |
| :--- | :--- | :--- |
| **Frontend** | React.js (CRA), Tailwind CSS, Context API | Modern, component-based UI, utility-first styling for speed. |
| **Backend** | Node.js, Express.js | Fast, non-blocking API layer with service-layer architecture. |
| **Database** | MySQL (via Sequelize ORM) | Relational integrity for Users, Orders, and Products. |
| **Caching/Queue**| Redis | High-speed storage for volatile data: OTP verification and Customer Carts. |
| **Authentication**| JWT, Bcrypt | Secure, stateless authentication with Role-Based Access Control (RBAC). |
| **Deployment** | Netlify (FE), Render (BE) | Optimized for modern CI/CD workflows and cost-efficiency. |
| **CI/CD** | GitHub Actions | Automated build and deployment pipeline integration. |

## ðŸ“‚ Project Structure

```
shoppy-backend/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ db.config.js       # MySQL connection parameters
â”‚   â””â”€â”€ redis.config.js    # Redis connection setup
â”œâ”€â”€ controllers/           # HTTP Request handlers
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ authJwt.js         # JWT verification & RBAC
â”‚   â””â”€â”€ validation.js      # Input sanitation and schema checks
â”œâ”€â”€ models/                # Sequelize schema definitions and associations (MVC Model)
â”œâ”€â”€ routes/                # API route definitions
â”œâ”€â”€ services/              # Business Logic (e.g., Auth, Cart, Checkout transactions)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ email.js           # Nodemailer integration
â”‚   â””â”€â”€ response.js        # Standardized API response format
â”œâ”€â”€ .env.example
â”œâ”€â”€ server.js              # Entry point
â””â”€â”€ package.json

shoppy-frontend/
â”œâ”€â”€ public/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ axiosInstance.js # JWT interceptor setup
â”‚   â”œâ”€â”€ components/        # Reusable UI elements
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â”œâ”€â”€ AuthContext.jsx
â”‚   â”‚   â””â”€â”€ CartContext.jsx  # Handles Redis Cart interaction
â”‚   â””â”€â”€ pages/             # Route-specific views (Dashboards, Auth)
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â””â”€â”€ tailwind.config.js
```

## ðŸ’» Local Setup Instructions

### Prerequisites

1.  Node.js (v18+) & npm
2.  MySQL Server (Local or Docker)
3.  Redis Server (Local or Docker)

### 1. Backend Setup (`shoppy-backend/`)

1.  **Install Dependencies:**
    ```bash
    cd shoppy-backend
    npm install
    ```
2.  **Configuration:**
    Create a `.env` file from `.env.example`.
    -   Configure `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`.
    -   Configure `REDIS_URL`.
    -   Configure `EMAIL_HOST`, `EMAIL_USER`, `EMAIL_PASS` (use **Ethereal** for testing if you don't have a service).
3.  **Run Migrations & Start:**
    The `server.js` automatically performs `db.sequelize.sync()`, creating all necessary tables.
    ```bash
    npm run dev
    # API runs on http://localhost:8080
    ```

### 2. Frontend Setup (`shoppy-frontend/`)

1.  **Install Dependencies:**
    ```bash
    cd shoppy-frontend
    npm install
    ```
2.  **Configuration:**
    Create a `.env` file from `.env.example`, ensuring the API URL is correct:
    ```
    REACT_APP_API_URL=http://localhost:8080/api
    ```
3.  **Start Application:**
    ```bash
    npm start
    # App runs on http://localhost:3000
    ```

## ðŸŒ API Endpoints Documentation

All endpoints are prefixed with `/api`.

### 1. Authentication (Public)

| Method | Path | Description | Role |
| :--- | :--- | :--- | :--- |
| `POST` | `/auth/signup` | Register a new user (`customer` or `seller`). Sends OTP. | Public |
| `POST` | `/auth/verify-otp` | Verify OTP sent to email. | Public |
| `POST` | `/auth/login` | Login user, returns JWT token. | Public |

### 2. Products (Public & Seller)

| Method | Path | Description | Role |
| :--- | :--- | :--- | :--- |
| `GET` | `/products` | List all products with `stock > 0`. | Public |
| `POST` | `/seller/products` | Create a new product. | Seller |
| `PUT` | `/seller/products/:id` | Update product details (stock, price, etc.). | Seller |

### 3. Cart & Checkout (Customer Only)

| Method | Path | Description | Role |
| :--- | :--- | :--- | :--- |
| `GET` | `/customer/cart` | Retrieve current cart items from Redis. | Customer |
| `POST` | `/customer/cart` | Add item/quantity to the cart. | Customer |
| `POST` | `/customer/checkout` | Finalize order (transactional DB update & stock decrement, clear Redis cart). | Customer |

### 4. Orders (Customer Only)

| Method | Path | Description | Role |
| :--- | :--- | :--- | :--- |
| `GET` | `/customer/orders` | View previous purchase history. | Customer |


--- END FILE: README.md ---

--- START FILE: shoppy-backend\.gitignore ---

# Dependencies
/node_modules
/dist

# Environment
.env
.DS_Store
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# OS
.vscode

--- END FILE: shoppy-backend\.gitignore ---

--- START FILE: shoppy-backend\package.json ---

{
  "name": "shoppy-backend",
  "version": "1.0.0",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "jsonwebtoken": "^9.0.3",
    "mysql2": "^3.16.1",
    "nodemailer": "^7.0.12",
    "redis": "^5.10.0",
    "sequelize": "^6.37.7"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}

--- END FILE: shoppy-backend\package.json ---

--- START FILE: shoppy-backend\server.js ---

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const db = require('./models');
const errorHandler = require('./middleware/errorHandler'); 

const app = express();
app.use(cors({ origin: process.env.CLIENT_URL || 'http://localhost:3000' }));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Database Sync (Creates tables if they don't exist)
db.sequelize.sync().then(() => {
    console.log("Database synced successfully.");
}).catch((err) => {
    console.error("Failed to sync database:", err.message);
});

// Redis Connection
require('./config/redis.config').checkConnection();

// Routes
require('./routes/auth.routes')(app);
require('./routes/product.routes')(app);
require('./routes/order.routes')(app);
require('./routes/cart.routes')(app); // <--- REQUIRED FIX: ADD THIS LINE

app.get('/', (req, res) => res.status(200).send({ message: "Shoppy API is running." }));

// Centralized Error Handler Middleware
app.use(errorHandler);

const PORT = process.env.PORT || 8080;
app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}.`);
});

--- END FILE: shoppy-backend\server.js ---

--- START FILE: shoppy-backend\.github\workflows\backend-ci-cd.yml ---

name: Shoppy Backend CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install
        
      # Optional: Add linting or unit test steps here 
      # - name: Run Linter
      #   run: npm run lint

      # Automatic deployment trigger to Render only on merge to 'main'
      - name: Trigger Render Deployment Hook
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "Initiating deployment via Render hook..."
          curl -X POST -H "Content-Type: application/json" -d '{}' $RENDER_DEPLOY_HOOK

--- END FILE: shoppy-backend\.github\workflows\backend-ci-cd.yml ---

--- START FILE: shoppy-backend\config\db.config.js ---

// shoppy-backend/config/db.config.js (Updated)

module.exports = {
    HOST: process.env.DB_HOST || "localhost",
    PORT: process.env.DB_PORT || 3306,
    USER: process.env.DB_USER || "root",
    PASSWORD: process.env.DB_PASSWORD || "password",
    DB: process.env.DB_NAME || "shoppy_db",
    dialect: "mysql",
    dialectOptions: {
        ssl: {
            // Must be false if we provide the CA certificate manually
            rejectUnauthorized: false, 
            
            // CRITICAL: Provide the CA certificate content here
            ca: process.env.CA_CERTIFICATE, // <-- NEW LINE
        }
    },
    pool: { max: 5, min: 0, acquire: 30000, idle: 10000 }
};

--- END FILE: shoppy-backend\config\db.config.js ---

--- START FILE: shoppy-backend\config\redis.config.js ---

const { createClient } = require('redis');

const REDIS_URL = process.env.REDIS_URL || 'redis://localhost:6379';

const redisClient = createClient({ url: REDIS_URL });

redisClient.on('error', (err) => console.error('Redis Client Error', err));

async function connectRedis() {
    await redisClient.connect();
    console.log("Redis connected successfully.");
}

function checkConnection() {
    if (!redisClient.isReady) {
        connectRedis().catch(err => {
            console.error("Failed to connect to Redis:", err.message);
        });
    }
}

module.exports = {
    redisClient,
    checkConnection
};

--- END FILE: shoppy-backend\config\redis.config.js ---

--- START FILE: shoppy-backend\controllers\auth.controller.js ---

const authService = require('../services/auth.service');
const { successResponse, errorResponse } = require('../utils/response');

exports.signup = async (req, res, next) => {
    try {
        const user = await authService.registerUser(req.body);
        successResponse(res, { email: user.email, role: user.role, message: "Registration successful. Check email for OTP." }, 'User registered.', 201);
    } catch (error) {
        next(error);
    }
};

exports.verifyOtp = async (req, res, next) => {
    try {
        const { email, otp } = req.body;
        const result = await authService.verifyOtp(email, otp);
        successResponse(res, result, 'OTP verified successfully.');
    } catch (error) {
        next(error);
    }
};

exports.login = async (req, res, next) => {
    try {
        const { email, password } = req.body;
        const data = await authService.loginUser(email, password);
        successResponse(res, data, 'Login successful.');
    } catch (error) {
        next(error);
    }
};

--- END FILE: shoppy-backend\controllers\auth.controller.js ---

--- START FILE: shoppy-backend\controllers\cart.controller.js ---

const cartService = require('../services/cart.service');
const { successResponse, errorResponse } = require('../utils/response');

exports.getCart = async (req, res, next) => {
    try {
        const cart = await cartService.getCart(req.userId);
        successResponse(res, cart, 'Cart retrieved successfully.');
    } catch (error) {
        next(error);
    }
};

exports.addToCart = async (req, res, next) => {
    try {
        const { productId, quantity } = req.body;
        const cart = await cartService.addItemToCart(req.userId, productId, quantity);
        successResponse(res, cart, 'Item added to cart.');
    } catch (error) {
        next(error);
    }
};

exports.updateCart = async (req, res, next) => {
    try {
        const { productId, quantity } = req.body;
        // Use the new service function to set the specific quantity
        const cart = await cartService.setCartItemQuantity(req.userId, productId, quantity);
        successResponse(res, cart, quantity > 0 ? 'Cart quantity updated.' : 'Item removed from cart.');
    } catch (error) {
        next(error);
    }
};

exports.checkout = async (req, res, next) => {
    try {
        const order = await cartService.checkoutCart(req.userId, req.body.shippingAddress);
        successResponse(res, order, 'Checkout successful! Order placed.', 201);
    } catch (error) {
        next(error);
    }
};


--- END FILE: shoppy-backend\controllers\cart.controller.js ---

--- START FILE: shoppy-backend\controllers\order.controller.js ---

const cartService = require('../services/cart.service');
const { successResponse } = require('../utils/response');

exports.getCustomerOrders = async (req, res, next) => {
    try {
        const orders = await cartService.getCustomerOrders(req.userId);
        successResponse(res, orders, 'Previous orders retrieved.');
    } catch (error) {
        next(error);
    }
};

--- END FILE: shoppy-backend\controllers\order.controller.js ---

--- START FILE: shoppy-backend\controllers\product.controller.js ---

// shoppy-backend/controllers/product.controller.js

const db = require('../models');
const { successResponse, errorResponse } = require('../utils/response');
const Product = db.product;

exports.createProduct = async (req, res, next) => {
    try {
        const { name, description, price, stock, imageUrl } = req.body;
        const product = await Product.create({
            name, description, price, stock, imageUrl, sellerId: req.userId
        });
        successResponse(res, product, 'Product added to stock successfully.', 201);
    } catch (error) {
        next(error);
    }
};

exports.getProducts = async (req, res, next) => {
    try {
        // Only return products where stock > 0
        const products = await Product.findAll({
            where: { stock: { [db.Sequelize.Op.gt]: 0 } },
            attributes: ['id', 'name', 'price', 'description', 'stock', 'imageUrl', 'sellerId']
        });
        successResponse(res, products, 'Products retrieved.');
    } catch (error) {
        next(error);
    }
};

// FIX: New Controller Function: Get products for a specific seller
exports.getSellerProducts = async (req, res, next) => {
    try {
        const products = await Product.findAll({
            where: { sellerId: req.userId }, // Crucial server-side filtering
            attributes: ['id', 'name', 'price', 'description', 'stock', 'imageUrl', 'sellerId'],
            order: [['createdAt', 'DESC']]
        });
        successResponse(res, products, 'Seller products retrieved.');
    } catch (error) {
        next(error);
    }
};

exports.updateStock = async (req, res, next) => {
    try {
        const productId = req.params.productId;
        const { stock, price, name, description, imageUrl } = req.body;

        const [updated] = await Product.update({
            stock, price, name, description, imageUrl
        }, {
            where: { id: productId, sellerId: req.userId }
        });

        if (updated === 0) {
            return errorResponse(res, 'Product not found or unauthorized to update.', 404);
        }

        const product = await Product.findByPk(productId);
        successResponse(res, product, 'Product updated successfully.');
    } catch (error) {
        next(error);
    }
};

--- END FILE: shoppy-backend\controllers\product.controller.js ---

--- START FILE: shoppy-backend\middleware\authJwt.js ---

const jwt = require('jsonwebtoken');

const verifyToken = (req, res, next) => {
    let token = req.headers['authorization']?.split(' ')[1]; // Expecting 'Bearer TOKEN'

    if (!token) {
        return res.status(403).send({ success: false, message: "No token provided!" });
    }

    jwt.verify(token, process.env.JWT_SECRET, (err, decoded) => {
        if (err) {
            // Token expired or invalid signature
            return res.status(401).send({ success: false, message: "Unauthorized! Token is invalid or expired." });
        }
        req.userId = decoded.id;
        req.userRole = decoded.role;
        next();
    });
};

const isRole = (role) => (req, res, next) => {
    if (req.userRole === role) {
        next();
    } else {
        res.status(403).send({ success: false, message: `Access Forbidden: Require ${role} Role.` });
    }
};

const authJwt = {
    verifyToken,
    isSeller: isRole('seller'),
    isCustomer: isRole('customer')
};

module.exports = authJwt;

--- END FILE: shoppy-backend\middleware\authJwt.js ---

--- START FILE: shoppy-backend\middleware\errorHandler.js ---

const { errorResponse } = require('../utils/response');

/**
 * Centralized Error Handling Middleware
 */
const errorHandler = (err, req, res, next) => {
    console.error(`Error encountered: ${err.message}`);
    // console.error(err.stack); // Optionally hide stack trace in production

    let statusCode = 500;
    let message = 'Internal Server Error';

    // Handle specific known errors (e.g., from Sequelize or custom service errors)
    if (err.name === 'SequelizeUniqueConstraintError') {
        statusCode = 409;
        message = 'Resource already exists (e.g., Email already registered).';
    } else if (err.message.includes('not found')) {
        statusCode = 404;
        message = err.message;
    } else if (err.message.includes('Invalid') || err.message.includes('required') || err.message.includes('stock') || err.message.includes('cannot') || err.message.includes('failed')) {
        statusCode = 400; // Bad Request for validation/logic errors
        message = err.message;
    }

    errorResponse(res, message, statusCode);
};

module.exports = errorHandler;

--- END FILE: shoppy-backend\middleware\errorHandler.js ---

--- START FILE: shoppy-backend\middleware\validation.js ---

const { errorResponse } = require('../utils/response');

const validateSignup = (req, res, next) => {
    const { email, password, role } = req.body;
    if (!email || !password || !role) {
        return errorResponse(res, 'Email, password, and role are required fields.', 400);
    }
    if (!['customer', 'seller'].includes(role.toLowerCase())) {
        return errorResponse(res, 'Invalid role specified. Must be customer or seller.', 400);
    }
    if (password.length < 6) {
        return errorResponse(res, 'Password must be at least 6 characters long.', 400);
    }
    next();
};

const validateProduct = (req, res, next) => {
    const { name, price, stock } = req.body;

    if (!name || !price || stock === undefined) {
        return errorResponse(res, 'Product name, price, and stock count are required.', 400);
    }
    if (isNaN(parseFloat(price)) || parseFloat(price) <= 0) {
        return errorResponse(res, 'Price must be a positive number.', 400);
    }
    if (!Number.isInteger(stock) || stock < 0) {
        return errorResponse(res, 'Stock must be a non-negative integer.', 400);
    }
    next();
};

const validateAddToCart = (req, res, next) => {
    const { productId, quantity } = req.body;
    if (!productId || quantity === undefined) {
        return errorResponse(res, 'Product ID and quantity are required.', 400);
    }
    if (!Number.isInteger(quantity) || quantity <= 0) {
        return errorResponse(res, 'Quantity must be a positive integer.', 400);
    }
    next();
};

module.exports = {
    validateSignup,
    validateProduct,
    validateAddToCart
};

--- END FILE: shoppy-backend\middleware\validation.js ---

--- START FILE: shoppy-backend\models\index.js ---

const dbConfig = require('../config/db.config');
const Sequelize = require('sequelize');
const sequelize = new Sequelize(dbConfig.DB, dbConfig.USER, dbConfig.PASSWORD, {
    host: dbConfig.HOST,
    port: dbConfig.PORT, // <-- NEW: Include port here
    dialect: dbConfig.dialect,
    operatorAliases: false,
    dialectOptions: dbConfig.dialectOptions, // <-- CRITICAL: Include dialect options for SSL
    pool: {
        max: dbConfig.pool.max,
        min: dbConfig.pool.min,
        acquire: dbConfig.pool.acquire,
        idle: dbConfig.pool.idle
    }
});
const db = {};

db.Sequelize = Sequelize;
db.sequelize = sequelize;

// Models
db.user = require('./user.model')(sequelize, Sequelize);
db.product = require('./product.model')(sequelize, Sequelize);
db.order = require('./order.model')(sequelize, Sequelize);
db.orderItem = require('./orderItem.model')(sequelize, Sequelize);

// Associations
// 1. User Associations
db.user.hasMany(db.product, { foreignKey: 'sellerId', as: 'products' });
db.user.hasMany(db.order, { foreignKey: 'userId', as: 'orders' });

// 2. Product Associations
db.product.belongsTo(db.user, { foreignKey: 'sellerId', as: 'seller' });
db.product.hasMany(db.orderItem, { foreignKey: 'productId', as: 'orderItems' });

// 3. Order Associations (Customer history)
db.order.belongsTo(db.user, { foreignKey: 'userId', as: 'customer' });
db.order.hasMany(db.orderItem, { foreignKey: 'orderId', as: 'items' });

// 4. OrderItem Associations (Junction table)
db.orderItem.belongsTo(db.order, { foreignKey: 'orderId', as: 'order' });
db.orderItem.belongsTo(db.product, { foreignKey: 'productId', as: 'product' });

module.exports = db;

--- END FILE: shoppy-backend\models\index.js ---

--- START FILE: shoppy-backend\models\order.model.js ---

module.exports = (sequelize, Sequelize) => {
    const Order = sequelize.define('Order', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        userId: {
            type: Sequelize.INTEGER,
            references: { model: 'Users', key: 'id' },
            allowNull: false
        },
        totalAmount: { type: Sequelize.DECIMAL(10, 2), allowNull: false },
        shippingAddress: { type: Sequelize.STRING },
        status: {
            type: Sequelize.ENUM('Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'),
            defaultValue: 'Pending'
        }
    });
    return Order;
};

--- END FILE: shoppy-backend\models\order.model.js ---

--- START FILE: shoppy-backend\models\orderItem.model.js ---

module.exports = (sequelize, Sequelize) => {
    const OrderItem = sequelize.define('OrderItem', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        orderId: {
            type: Sequelize.INTEGER,
            references: { model: 'Orders', key: 'id' },
            allowNull: false
        },
        productId: {
            type: Sequelize.INTEGER,
            references: { model: 'Products', key: 'id' },
            allowNull: false
        },
        quantity: { type: Sequelize.INTEGER, allowNull: false },
        priceAtPurchase: { type: Sequelize.DECIMAL(10, 2), allowNull: false }
    });
    return OrderItem;
};

--- END FILE: shoppy-backend\models\orderItem.model.js ---

--- START FILE: shoppy-backend\models\product.model.js ---

module.exports = (sequelize, Sequelize) => {
    const Product = sequelize.define('Product', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        name: { type: Sequelize.STRING, allowNull: false },
        description: { type: Sequelize.TEXT },
        price: { type: Sequelize.DECIMAL(10, 2), allowNull: false },
        stock: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 0 },
        imageUrl: { type: Sequelize.STRING },
        sellerId: {
            type: Sequelize.INTEGER,
            references: { model: 'Users', key: 'id' },
            allowNull: false
        }
    });
    return Product;
};

--- END FILE: shoppy-backend\models\product.model.js ---

--- START FILE: shoppy-backend\models\user.model.js ---

module.exports = (sequelize, Sequelize) => {
    const User = sequelize.define('User', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        email: { type: Sequelize.STRING, unique: true, allowNull: false },
        password: { type: Sequelize.STRING, allowNull: false },
        role: {
            type: Sequelize.ENUM('customer', 'seller'),
            allowNull: false,
            defaultValue: 'customer'
        },
        isVerified: { type: Sequelize.BOOLEAN, defaultValue: false }
    });
    return User;
};

--- END FILE: shoppy-backend\models\user.model.js ---

--- START FILE: shoppy-backend\routes\auth.routes.js ---

const controller = require("../controllers/auth.controller");
const { validateSignup } = require("../middleware/validation");

module.exports = function(app) {
    app.use(function(req, res, next) {
        res.header(
            "Access-Control-Allow-Headers",
            "x-access-token, Origin, Content-Type, Accept"
        );
        next();
    });

    app.post("/api/auth/signup", validateSignup, controller.signup);
    app.post("/api/auth/verify-otp", controller.verifyOtp);
    app.post("/api/auth/login", controller.login);
};

--- END FILE: shoppy-backend\routes\auth.routes.js ---

--- START FILE: shoppy-backend\routes\cart.routes.js ---

const controller = require("../controllers/cart.controller");
const { verifyToken, isCustomer } = require("../middleware/authJwt");
const { validateAddToCart } = require("../middleware/validation");

module.exports = function(app) {
    // Requires Customer role
    app.get("/api/customer/cart", [verifyToken, isCustomer], controller.getCart);
    
    // POST for incrementing/adding new item
    app.post("/api/customer/cart", [verifyToken, isCustomer, validateAddToCart], controller.addToCart);
    
    // FIX: PUT for setting specific quantity (including 0 to remove)
    app.put("/api/customer/cart", [verifyToken, isCustomer, validateAddToCart], controller.updateCart);

    app.post("/api/customer/checkout", [verifyToken, isCustomer], controller.checkout);
};

--- END FILE: shoppy-backend\routes\cart.routes.js ---

--- START FILE: shoppy-backend\routes\order.routes.js ---

const controller = require("../controllers/order.controller");
const { verifyToken, isCustomer } = require("../middleware/authJwt");

module.exports = function(app) {
    // Requires Customer role
    app.get("/api/customer/orders", [verifyToken, isCustomer], controller.getCustomerOrders);
};

--- END FILE: shoppy-backend\routes\order.routes.js ---

--- START FILE: shoppy-backend\routes\product.routes.js ---

// shoppy-backend/routes/product.routes.js

const controller = require("../controllers/product.controller");
const { verifyToken, isSeller } = require("../middleware/authJwt");
const { validateProduct } = require("../middleware/validation");

module.exports = function(app) {
    // PUBLIC Route: View all available products
    app.get("/api/products", controller.getProducts);

    // SECURE Seller Routes
    
    // FIX: New Route: Get products only for the logged-in seller
    app.get("/api/seller/products", [verifyToken, isSeller], controller.getSellerProducts);

    app.post(
        "/api/seller/products",
        [verifyToken, isSeller, validateProduct],
        controller.createProduct
    );

    app.put(
        "/api/seller/products/:productId",
        [verifyToken, isSeller, validateProduct],
        controller.updateStock
    );
};

--- END FILE: shoppy-backend\routes\product.routes.js ---

--- START FILE: shoppy-backend\services\auth.service.js ---

const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const db = require('../models');
const { redisClient } = require('../config/redis.config');
const { sendOtpEmail } = require('../utils/email');

const User = db.user;
const OTP_TTL = 600; // 10 minutes

const generateOTP = () => Math.floor(100000 + Math.random() * 900000).toString();

const registerUser = async ({ email, password, role }) => {
    const hashedPassword = bcrypt.hashSync(password, 8);
    
    const user = await User.create({ email, password: hashedPassword, role, isVerified: false });

    const otp = generateOTP();
    const redisKey = `otp:${user.email}`;

    await redisClient.set(redisKey, otp, { EX: OTP_TTL });
    await sendOtpEmail(user.email, otp);

    return user;
};

const verifyOtp = async (email, otp) => {
    const redisKey = `otp:${email}`;
    const storedOtp = await redisClient.get(redisKey);

    if (!storedOtp || storedOtp !== otp) {
        throw new Error('Invalid or expired OTP.');
    }

    const [updatedRows] = await User.update({ isVerified: true }, { where: { email } });
    if (updatedRows === 0) throw new Error('User not found.');

    await redisClient.del(redisKey);
    return { message: "Account verified successfully." };
};

const loginUser = async (email, password) => {
    const user = await User.findOne({ where: { email } });

    if (!user) throw new Error('User not found.');
    if (!user.isVerified) throw new Error('Account not verified. Please verify your OTP.');
    if (!bcrypt.compareSync(password, user.password)) throw new Error('Invalid Password!');

    const token = jwt.sign(
        { id: user.id, role: user.role },
        process.env.JWT_SECRET,
        { expiresIn: 86400 } // 24 hours
    );

    return { id: user.id, email: user.email, role: user.role, accessToken: token };
};

module.exports = { registerUser, verifyOtp, loginUser };

--- END FILE: shoppy-backend\services\auth.service.js ---

--- START FILE: shoppy-backend\services\cart.service.js ---

const db = require('../models');
const { redisClient } = require('../config/redis.config');
const Product = db.product;
const Order = db.order;
const OrderItem = db.orderItem;

const getCartKey = (userId) => `cart:${userId}`;

// Fetch Cart (from Redis)
const getCart = async (userId) => {
    const cartData = await redisClient.get(getCartKey(userId));
    return cartData ? JSON.parse(cartData) : { items: [], total: 0 };
};

// Add Item to Cart (Update Redis - INCREMENTING)
const addItemToCart = async (userId, productId, quantity) => {
    const product = await Product.findByPk(productId);
    if (!product) throw new Error("Product not found.");
    
    const cart = await getCart(userId);
    let existingItem = cart.items.find(item => item.productId === productId);

    let currentCartQuantity = existingItem ? existingItem.quantity : 0;
    let projectedQuantity = currentCartQuantity + quantity;

    if (projectedQuantity > product.stock) {
        throw new Error(`Insufficient stock. Available stock: ${product.stock}. You currently have ${currentCartQuantity} units in your cart.`);
    }

    if (existingItem) {
        // Use the calculated projected quantity
        existingItem.quantity = projectedQuantity;
    } else {
        cart.items.push({
            productId: product.id, name: product.name,
            price: parseFloat(product.price), quantity: quantity
        });
    }

    cart.total = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    await redisClient.set(getCartKey(userId), JSON.stringify(cart));
    return cart;
};

// FIX: Set Item Quantity (SETTING ABSOLUTE quantity, 0 to remove)
const setCartItemQuantity = async (userId, productId, newQuantity) => {
    const cart = await getCart(userId);
    const existingIndex = cart.items.findIndex(item => item.productId === productId);

    if (newQuantity <= 0) {
        // Remove item
        if (existingIndex !== -1) {
            cart.items.splice(existingIndex, 1);
        }
    } else {
        const product = await Product.findByPk(productId);
        if (!product) throw new Error("Product not found.");

        if (newQuantity > product.stock) {
            throw new Error(`Insufficient stock. Available stock: ${product.stock}.`);
        }

        // Use the price from the database at the time of update
        const price = parseFloat(product.price); 
        
        const itemDetails = {
            productId: product.id, name: product.name,
            price: price, quantity: newQuantity
        };

        if (existingIndex !== -1) {
            cart.items[existingIndex] = itemDetails; // Update quantity
        } else {
            cart.items.push(itemDetails); // Add new item
        }
    }

    // Recalculate total
    cart.total = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    await redisClient.set(getCartKey(userId), JSON.stringify(cart));
    return cart;
};


// Checkout (Transactional - DB write & Stock update)
const checkoutCart = async (userId, address = "Default Shipping Address") => {
    const cart = await getCart(userId);
    if (cart.items.length === 0) throw new Error("Cannot checkout an empty cart.");

    const t = await db.sequelize.transaction(); // START TRANSACTION

    try {
        const newOrder = await Order.create({
            userId, totalAmount: cart.total, shippingAddress: address, status: 'Pending'
        }, { transaction: t });

        const orderItemsData = [];
        for (const item of cart.items) {
            const product = await Product.findByPk(item.productId, { transaction: t });

            if (!product || product.stock < item.quantity) {
                await t.rollback();
                throw new Error(`Insufficient stock for product: ${item.name}`);
            }

            // Decrement stock and store price at purchase time
            await product.decrement('stock', { by: item.quantity, transaction: t });

            orderItemsData.push({
                orderId: newOrder.id, productId: item.productId,
                quantity: item.quantity, priceAtPurchase: item.price,
            });
        }
        
        await OrderItem.bulkCreate(orderItemsData, { transaction: t });
        await redisClient.del(getCartKey(userId)); // Clear Redis cart

        await t.commit(); // COMMIT TRANSACTION
        return newOrder;

    } catch (error) {
        await t.rollback();
        throw new Error(`Checkout failed: ${error.message}`);
    }
};

const getCustomerOrders = async (userId) => {
    return Order.findAll({
        where: { userId },
        include: [{ 
            model: OrderItem, as: 'items', 
            include: [{ model: Product, as: 'product', attributes: ['name', 'imageUrl'] }] 
        }],
        order: [['createdAt', 'DESC']]
    });
};

// Clean up module exports
module.exports = { 
    addItemToCart, 
    getCart, 
    checkoutCart, 
    getCustomerOrders,
    setCartItemQuantity // <--- EXPORT NEW FUNCTION
};

--- END FILE: shoppy-backend\services\cart.service.js ---

--- START FILE: shoppy-backend\utils\email.js ---

const nodemailer = require('nodemailer');

const transporter = nodemailer.createTransport({
    host: process.env.EMAIL_HOST,
    port: process.env.EMAIL_PORT,
    secure: process.env.EMAIL_SECURE === 'true',
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
    }
});

const sendOtpEmail = async (email, otp) => {
    try {
        await transporter.sendMail({
            from: `"Shoppy Support" <${process.env.EMAIL_USER}>`,
            to: email,
            subject: "Shoppy Account Verification OTP",
            html: `Your OTP for Shoppy is: <h1>${otp}</h1>. This is valid for 10 minutes.`,
        });
        console.log(`OTP email sent to ${email}`);
        return true;
    } catch (error) {
        console.error("Error sending OTP email:", error);
        throw new Error("Failed to send verification email. Check SMTP settings.");
    }
};

module.exports = { sendOtpEmail };

--- END FILE: shoppy-backend\utils\email.js ---

--- START FILE: shoppy-backend\utils\response.js ---

/**
 * Standardized API Response utilities
 */
const successResponse = (res, data, message = 'Operation successful', status = 200) => {
    res.status(status).json({
        success: true,
        message,
        data,
    });
};

const errorResponse = (res, message = 'An unexpected error occurred', status = 500) => {
    res.status(status).json({
        success: false,
        message,
        data: null,
    });
};

module.exports = { successResponse, errorResponse };

--- END FILE: shoppy-backend\utils\response.js ---

--- START FILE: shoppy-frontend\.gitignore ---

# Dependencies
/node_modules
/build

# Testing
/coverage

# Environment
.env
.DS_Store

# Logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# IDEs
.vscode

--- END FILE: shoppy-frontend\.gitignore ---

--- START FILE: shoppy-frontend\package.json ---

{
  "name": "shoppy-frontend",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "autoprefixer": "^10.4.23",
    "axios": "^1.13.2",
    "react": "^19.2.3",
    "react-dom": "^19.2.3",
    "react-icons": "^5.5.0",
    "react-router-dom": "^7.12.0",
    "react-scripts": "5.0.1",
    "tailwindcss": "^3.3.3",
    "web-vitals": "^5.1.0"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  }
}


--- END FILE: shoppy-frontend\package.json ---

--- START FILE: shoppy-frontend\postcss.config.js ---

// shoppy-frontend/postcss.config.js
module.exports = {
  plugins: [
    // Use the explicit require syntax for maximum compatibility
    require('tailwindcss'),
    require('autoprefixer'),
  ],
};

--- END FILE: shoppy-frontend\postcss.config.js ---

--- START FILE: shoppy-frontend\tailwind.config.js ---

/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{js,jsx,ts,tsx}", // CRITICAL: This line must be correct
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

--- END FILE: shoppy-frontend\tailwind.config.js ---

--- START FILE: shoppy-frontend\public\index.html ---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Shoppy V2 - Full-Stack E-commerce Platform"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Shoppy V2</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!--
      This file is the template for the generated HTML.
      It is provided for completeness.
    -->
  </body>
</html>

--- END FILE: shoppy-frontend\public\index.html ---

--- START FILE: shoppy-frontend\src\App.jsx ---

import React from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';
import { CartProvider } from './context/CartContext'; // <-- Add CartProvider import here
import Header from './components/shared/Header';
import ProtectedRoute from './components/shared/ProtectedRoute';
import Home from './pages/Home';
import Login from './pages/Login';
import Signup from './pages/Signup';
import OtpVerification from './pages/OtpVerification';
import CustomerDashboard from './pages/CustomerDashboard';
import SellerDashboard from './pages/SellerDashboard';

const App = () => {
    return (
        <Router>
            {/* 1. AuthProvider must be the highest level context consumer */}
            <AuthProvider> 
                {/* 2. CartProvider depends on AuthProvider, so it must be nested inside */}
                <CartProvider> 
                    <Header />
                    <main className="container mx-auto p-4 pt-20 min-h-screen bg-gray-50">
                        <Routes>
                        <Route path="/" element={<Home />} />
                        <Route path="/login" element={<Login />} />
                        <Route path="/signup" element={<Signup />} />
                        <Route path="/verify-otp" element={<OtpVerification />} />

                        <Route path="/customer/dashboard" element={
                            <ProtectedRoute allowedRoles={['customer']}><CustomerDashboard /></ProtectedRoute>
                        } />

                        <Route path="/seller/dashboard" element={
                            <ProtectedRoute allowedRoles={['seller']}><SellerDashboard /></ProtectedRoute>
                        } />

                        <Route path="*" element={<h1 className="text-xl">404 Not Found</h1>} />
                        </Routes>
                    </main>
                </CartProvider>
            </AuthProvider>
        </Router>
    );
};

export default App;

--- END FILE: shoppy-frontend\src\App.jsx ---

--- START FILE: shoppy-frontend\src\index.css ---

@tailwind base;
@tailwind components;
@tailwind utilities;

/* Base styles for production readiness */
body {
    font-family: 'Inter', sans-serif;
    background-color: #f7f9fb;
}

/* Custom component styles */
.btn-primary {
    @apply bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded transition duration-200;
}

.card {
    @apply bg-white border border-gray-200 rounded-lg shadow-md p-4;
}

--- END FILE: shoppy-frontend\src\index.css ---

--- START FILE: shoppy-frontend\src\index.js ---

import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App';
// REMOVE: import { CartProvider } from './context/CartContext'; // <-- REMOVE THIS LINE IF PRESENT

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    {/* Only render App here */}
    <App /> 
  </React.StrictMode>
);

--- END FILE: shoppy-frontend\src\index.js ---

--- START FILE: shoppy-frontend\src\api\axiosInstance.js ---

import axios from 'axios';

const API_URL = process.env.REACT_APP_API_URL || "http://localhost:8080/api";

const axiosInstance = axios.create({
    baseURL: API_URL,
    headers: { "Content-type": "application/json" },
});

// Interceptor for attaching JWT Token to requests
axiosInstance.interceptors.request.use(
    (config) => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user && user.accessToken) {
            config.headers["Authorization"] = `Bearer ${user.accessToken}`;
        }
        return config;
    },
    (error) => Promise.reject(error)
);

export default axiosInstance;

--- END FILE: shoppy-frontend\src\api\axiosInstance.js ---

--- START FILE: shoppy-frontend\src\components\shared\Header.jsx ---

import React from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { useCart } from '../../context/CartContext';
import { FaShoppingCart, FaSignOutAlt } from 'react-icons/fa';

const Header = () => {
    const { isAuthenticated, user, logout } = useAuth();
    const { cart } = useCart();
    
    const cartItemCount = cart.items ? cart.items.reduce((sum, item) => sum + item.quantity, 0) : 0;

    return (
        <header className="fixed top-0 left-0 right-0 bg-white shadow-md z-10">
            <div className="container mx-auto flex justify-between items-center p-4">
                <Link to="/" className="text-2xl font-bold text-indigo-600">Shoppy</Link>
                <nav className="flex space-x-6 items-center">
                    {isAuthenticated ? (
                        <>
                            {/* Safe check for role access */}
                            {user?.role === 'customer' && (
                                <>
                                    <Link to="/customer/dashboard" className="text-gray-700 hover:text-indigo-600">
                                        Shop
                                    </Link>
                                    <div className="relative">
                                        <span className="text-gray-700 hover:text-indigo-600 cursor-pointer flex items-center">
                                            <FaShoppingCart className="mr-1" /> Cart ({cartItemCount})
                                        </span>
                                    </div>
                                </>
                            )}
                            {user?.role === 'seller' && (
                                <Link to="/seller/dashboard" className="text-gray-700 hover:text-indigo-600">
                                    Inventory
                                </Link>
                            )}
                            
                            {/* Safe check for user email access */}
                            <span className="text-sm text-gray-500 hidden md:block">
                                Welcome, {user?.email} 
                            </span>
                            <button onClick={logout} className="btn-primary bg-red-600 hover:bg-red-700 text-sm flex items-center">
                                <FaSignOutAlt className="mr-1" /> Logout
                            </button>
                        </>
                    ) : (
                        <>
                            <Link to="/login" className="text-gray-700 hover:text-indigo-600">Login</Link>
                            <Link to="/signup" className="btn-primary">Sign Up</Link>
                        </>
                    )}
                </nav>
            </div>
        </header>
    );
};

export default Header;

--- END FILE: shoppy-frontend\src\components\shared\Header.jsx ---

--- START FILE: shoppy-frontend\src\components\shared\ProtectedRoute.jsx ---

import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';

const ProtectedRoute = ({ children, allowedRoles }) => {
    // We rely on isLoading being false when local storage check is done.
    const { isAuthenticated, role, isLoading } = useAuth();

    if (isLoading) {
        // Must show loading state while local storage is being processed
        return <div className="text-center p-10 text-xl">Loading authentication state...</div>;
    }

    if (!isAuthenticated) {
        // Not logged in -> redirect to login
        return <Navigate to="/login" replace />;
    }

    // FIX: If the user is authenticated but somehow the role is missing or hasn't loaded 
    // (though AuthContext tries to prevent this), prevent access immediately.
    if (!role) {
        console.error("Authenticated user has no defined role. Redirecting to home.");
        return <Navigate to="/" replace />;
    }

    if (allowedRoles && !allowedRoles.includes(role)) {
        // Logged in but unauthorized role -> redirect to home
        console.warn(`Access Denied. User role: ${role}. Required: ${allowedRoles.join(', ')}`);
        return <Navigate to="/" replace state={{ message: "Access Denied: Insufficient role." }} />;
    }

    return children;
};

export default ProtectedRoute;

--- END FILE: shoppy-frontend\src\components\shared\ProtectedRoute.jsx ---

--- START FILE: shoppy-frontend\src\context\AuthContext.jsx ---

import React, { createContext, useState, useContext, useEffect } from 'react';
import axios from '../api/axiosInstance';
import { useNavigate } from 'react-router-dom';

const AuthContext = createContext();
export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const navigate = useNavigate();

    useEffect(() => {
        const storedUser = localStorage.getItem('user');
        let initialUser = null;

        if (storedUser) {
            const userData = JSON.parse(storedUser);
            // CRITICAL FIX: Ensure both accessToken and role are present when loading from storage
            if (userData.accessToken && userData.role) { 
                 initialUser = userData;
            } else {
                // If token or role is missing/invalid in storage, clear it
                localStorage.removeItem('user');
            }
        }
        
        // Set both states atomically after reading storage
        setUser(initialUser);
        setIsLoading(false);
        
    }, []);

    const login = async (email, password) => {
        const response = await axios.post("/auth/login", { email, password });
        
        // FIX: Extract user data correctly from the nested 'data' field provided by the backend's successResponse wrapper
        const userData = response.data.data; 

        if (!userData || !userData.role) {
            throw new Error("Login data corrupted: role missing.");
        }

        const loginData = {
            id: userData.id,
            email: userData.email,
            role: userData.role,
            accessToken: userData.accessToken
        };
        
        localStorage.setItem("user", JSON.stringify(loginData));
        setUser(loginData);

        // Navigate based on the newly set role
        navigate(loginData.role === 'seller' ? '/seller/dashboard' : '/customer/dashboard');
    };

    const logout = () => {
        localStorage.removeItem("user");
        setUser(null);
        navigate('/login');
    };

    const value = { 
        user, 
        isLoading, 
        isAuthenticated: !!user, 
        role: user?.role, 
        login, 
        logout 
    };

    if (isLoading) return <div className="text-center p-10">Loading...</div>;
    return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

--- END FILE: shoppy-frontend\src\context\AuthContext.jsx ---

--- START FILE: shoppy-frontend\src\context\CartContext.jsx ---

import React, { createContext, useState, useContext, useEffect, useCallback } from 'react';
import axios from '../api/axiosInstance';
import { useAuth } from './AuthContext';

const CartContext = createContext();
export const useCart = () => useContext(CartContext);

export const CartProvider = ({ children }) => {
    const { isAuthenticated, role } = useAuth();
    const [cart, setCart] = useState({ items: [], total: 0 });
    const [loading, setLoading] = useState(false);

    const fetchCart = useCallback(async () => {
        if (!isAuthenticated || role !== 'customer') {
            setCart({ items: [], total: 0 });
            return;
        }
        setLoading(true);
        try {
            const response = await axios.get('/customer/cart');
            setCart(response.data.data);
        } catch (error) {
            console.error("Failed to fetch cart:", error);
            // On failure, rely on an empty cart state
            setCart({ items: [], total: 0 });
        } finally {
            setLoading(false);
        }
    }, [isAuthenticated, role]);

    useEffect(() => {
        fetchCart();
    }, [fetchCart]);

    const addToCart = async (productId, quantity = 1) => {
        if (role !== 'customer') return alert("Only customers can use the cart.");
        setLoading(true);
        try {
            // This POST endpoint handles INCREMENTING the quantity
            const response = await axios.post('/customer/cart', { productId, quantity });
            setCart(response.data.data);
            alert("Item added successfully!");
        } catch (error) {
            alert(error.response?.data?.message || "Failed to add item to cart.");
        } finally {
            setLoading(false);
        }
    };
    
    /**
     * UX Improvement: Sets the specific quantity of a product in the cart.
     * Uses the new backend PUT route to set the absolute quantity (0 removes item).
     */
    const updateCartItemQuantity = async (productId, quantity) => {
        if (role !== 'customer') return;
        
        // Basic validation
        if (quantity < 0) return alert("Quantity cannot be negative.");

        setLoading(true);
        try {
            // FIX: Use the dedicated PUT /customer/cart route for setting quantity
            const response = await axios.put(`/customer/cart`, { productId, quantity }); 
            setCart(response.data.data);
            if (quantity === 0) {
                 alert("Item removed from cart.");
            } else {
                 alert("Cart quantity updated.");
            }
        } catch (error) {
            alert(error.response?.data?.message || "Failed to update cart item.");
        } finally {
            setLoading(false);
        }
    };
    
    const removeFromCart = (productId) => {
        // Removes item by setting quantity to 0
        updateCartItemQuantity(productId, 0);
    }

    const checkout = async () => {
        if (cart.items.length === 0) {
            alert("Cannot checkout an empty cart.");
            return false;
        }
        setLoading(true);
        try {
            await axios.post('/customer/checkout', { shippingAddress: 'User Default Address' });
            setCart({ items: [], total: 0 }); // Clear cart on success
            alert("Order placed successfully! Check order history.");
            return true;
        } catch (error) {
            alert(error.response?.data?.message || "Checkout failed due to stock or server error.");
            // If checkout fails, re-fetch the potentially modified cart state
            fetchCart(); 
            return false;
        } finally {
            setLoading(false);
        }
    };

    const value = { 
        cart, 
        loading, 
        fetchCart, 
        addToCart, 
        checkout,
        updateCartItemQuantity, 
        removeFromCart 
    };

    return <CartContext.Provider value={value}>{children}</CartContext.Provider>;
};

--- END FILE: shoppy-frontend\src\context\CartContext.jsx ---

--- START FILE: shoppy-frontend\src\pages\CustomerDashboard.jsx ---

import React, { useState, useEffect, useCallback } from 'react';
import axios from '../api/axiosInstance';
import { useCart } from '../context/CartContext';
import { FaShoppingCart, FaListAlt } from 'react-icons/fa';

const ProductCard = ({ product, addToCart }) => (
    <div className="card h-full flex flex-col justify-between">
        <div>
            <img src={product.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'} alt={product.name} className="w-full h-40 object-cover rounded-t-lg mb-4" />
            <h3 className="text-xl font-semibold text-gray-800">{product.name}</h3>
            <p className="text-2xl font-bold text-indigo-600 mb-2">${product.price}</p>
            <p className="text-sm text-gray-500 mb-4">{product.description}</p>
        </div>
        <div className="flex justify-between items-center">
            <span className={`text-sm font-medium ${product.stock > 10 ? 'text-green-600' : 'text-orange-500'}`}>
                Stock: {product.stock}
            </span>
            <button 
                onClick={() => addToCart(product.id, 1)} 
                className="btn-primary px-3 py-1 text-sm"
                disabled={product.stock === 0}
            >
                Add to Cart
            </button>
        </div>
    </div>
);

const CartDisplay = () => {
    const { cart, loading, checkout } = useCart();

    const handleCheckout = async () => {
        await checkout();
    };

    return (
        <div className="card sticky top-20">
            <h2 className="text-2xl font-bold mb-4 flex items-center text-indigo-600">
                <FaShoppingCart className="mr-2" /> Your Cart
            </h2>
            {loading ? (
                <p>Loading cart...</p>
            ) : cart.items && cart.items.length > 0 ? (
                <>
                    <ul className="space-y-3 mb-4 max-h-60 overflow-y-auto">
                        {cart.items.map((item, index) => (
                            <li key={index} className="flex justify-between border-b pb-2">
                                <span>{item.name} x {item.quantity}</span>
                                <span className="font-semibold">${(item.price * item.quantity).toFixed(2)}</span>
                            </li>
                        ))}
                    </ul>
                    <div className="text-xl font-bold pt-4 border-t">
                        Total: ${cart.total ? cart.total.toFixed(2) : '0.00'}
                    </div>
                    <button 
                        onClick={handleCheckout}
                        className="btn-primary w-full mt-4 bg-green-600 hover:bg-green-700"
                        disabled={loading}
                    >
                        {loading ? 'Processing...' : 'Checkout Cart'}
                    </button>
                </>
            ) : (
                <p className="text-gray-500">Your cart is empty.</p>
            )}
        </div>
    );
};

const OrderHistory = () => {
    const [orders, setOrders] = useState([]);
    const [loading, setLoading] = useState(true);

    const fetchOrders = useCallback(async () => {
        setLoading(true);
        try {
            const response = await axios.get('/customer/orders');
            setOrders(response.data.data);
        } catch (error) {
            console.error("Failed to fetch orders:", error);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        fetchOrders();
    }, [fetchOrders]);

    if (loading) return <p className="p-4">Loading orders...</p>;
    
    return (
        <div className="mt-8 card">
            <h2 className="text-2xl font-bold mb-4 flex items-center text-indigo-600">
                <FaListAlt className="mr-2" /> Order History
            </h2>
            {orders.length === 0 ? (
                <p>You have no previous orders.</p>
            ) : (
                <div className="space-y-4">
                    {orders.map(order => (
                        <div key={order.id} className="border p-4 rounded-lg bg-gray-50">
                            <div className="flex justify-between font-semibold mb-2">
                                <span>Order #{order.id}</span>
                                <span className={`p-1 text-xs rounded ${order.status === 'Delivered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}`}>
                                    {order.status}
                                </span>
                            </div>
                            <p className="text-sm text-gray-600 mb-2">Total: ${order.totalAmount}</p>
                            <p className="text-xs text-gray-500">Placed: {new Date(order.createdAt).toLocaleDateString()}</p>
                            <h4 className="font-medium mt-2">Items:</h4>
                            <ul className="list-disc list-inside text-sm">
                                {order.items.map(item => (
                                    <li key={item.id}>
                                        {/* Fallback check for product name if not included in BE model include */}
                                        {item.product?.name || 'Item Detail Missing'} ({item.quantity} units @ ${item.priceAtPurchase})
                                    </li>
                                ))}
                            </ul>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const CustomerDashboard = () => {
    const [products, setProducts] = useState([]);
    const [loading, setLoading] = useState(true);
    const { addToCart } = useCart();

    const fetchProducts = useCallback(async () => {
        setLoading(true);
        try {
            const response = await axios.get('/products');
            setProducts(response.data.data);
        } catch (error) {
            console.error("Failed to fetch products:", error);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        fetchProducts();
    }, [fetchProducts]);

    return (
        <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-6">Customer Shop</h1>
            
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                {/* Product List (3 columns) */}
                <div className="lg:col-span-3">
                    <h2 className="text-2xl font-semibold mb-4 text-gray-700">Available Products</h2>
                    {loading ? (
                        <p>Loading products...</p>
                    ) : products.length === 0 ? (
                        <p>No products currently in stock that are visible for purchase.</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            {products.map(product => (
                                <ProductCard key={product.id} product={product} addToCart={addToCart} />
                            ))}
                        </div>
                    )}
                    
                    {/* Order History Section */}
                    <OrderHistory />
                </div>
                
                {/* Cart Sidebar (1 column) */}
                <div className="lg:col-span-1">
                    <CartDisplay />
                </div>
            </div>
        </div>
    );
};

export default CustomerDashboard;

--- END FILE: shoppy-frontend\src\pages\CustomerDashboard.jsx ---

--- START FILE: shoppy-frontend\src\pages\Home.jsx ---

import React from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const Home = () => {
    const { isAuthenticated, role } = useAuth();

    // Determine the dashboard path robustly: defaults to customer if role is undefined or customer
    const dashboardPath = role === 'seller' ? '/seller/dashboard' : '/customer/dashboard';
    // Ensure role text is displayed correctly
    const displayRole = role ? role.toUpperCase() : 'Authenticated User';

    return (
        <div className="text-center py-20">
            <h1 className="text-5xl font-extrabold text-gray-900 mb-4">Welcome to Shoppy V2</h1>
            <p className="text-xl text-gray-600 mb-8">
                Your next-generation e-commerce platform built on React, Node, Redis, and MySQL.
            </p>
            
            {!isAuthenticated ? (
                <div className="space-x-4">
                    <Link to="/login" className="btn-primary">
                        Login
                    </Link>
                    <Link to="/signup" className="btn-primary bg-green-600 hover:bg-green-700">
                        Register Now
                    </Link>
                </div>
            ) : (
                <div className="mt-8 p-6 bg-indigo-50 border-l-4 border-indigo-500 inline-block rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-indigo-700 mb-3">
                        {`You are logged in as a ${displayRole}`}
                    </h2>
                    <Link 
                        to={dashboardPath} // Use the robustly calculated path
                        className="text-lg text-indigo-600 hover:text-indigo-800 underline"
                    >
                        Go to your Dashboard &rarr;
                    </Link>
                </div>
            )}

            <div className="mt-16 grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <div className="card text-left">
                    <h3 className="text-xl font-bold mb-2 text-indigo-600">For Customers</h3>
                    <p className="text-gray-600">Browse available products, add items to your high-speed Redis-backed cart, and track your previous orders.</p>
                </div>
                <div className="card text-left">
                    <h3 className="text-xl font-bold mb-2 text-indigo-600">For Sellers</h3>
                    <p className="text-gray-600">Manage your product inventory, update stock levels, and make your items visible to thousands of potential customers.</p>
                </div>
            </div>
        </div>
    );
};

export default Home;

--- END FILE: shoppy-frontend\src\pages\Home.jsx ---

--- START FILE: shoppy-frontend\src\pages\Login.jsx ---

import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const Login = () => {
    const [formData, setFormData] = useState({ email: '', password: '' });
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const { login } = useAuth();

    const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
            await login(formData.email, formData.password);
        } catch (err) {
            setError(err.response?.data?.message || 'Login failed. Check your credentials and verification status.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10 bg-white p-8 border rounded-lg shadow-xl">
            <h2 className="text-3xl font-bold text-center mb-6 text-indigo-600">Login to Shoppy</h2>
            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}
            <form onSubmit={handleSubmit}>
                <div className="mb-4">
                    <label className="block text-gray-700">Email</label>
                    <input type="email" name="email" value={formData.email} onChange={handleChange} required className="w-full p-2 border rounded" />
                </div>
                <div className="mb-6">
                    <label className="block text-gray-700">Password</label>
                    <input type="password" name="password" value={formData.password} onChange={handleChange} required className="w-full p-2 border rounded" />
                </div>
                <button type="submit" disabled={loading} className="btn-primary w-full disabled:opacity-50">
                    {loading ? 'Logging In...' : 'Log In'}
                </button>
            </form>
            <p className="mt-4 text-center"><Link to="/signup" className="text-indigo-600 hover:underline">Need an account? Sign Up</Link></p>
        </div>
    );
};

export default Login;

--- END FILE: shoppy-frontend\src\pages\Login.jsx ---

--- START FILE: shoppy-frontend\src\pages\OtpVerification.jsx ---

import React, { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import axios from '../api/axiosInstance';

const OtpVerification = () => {
    const location = useLocation();
    const navigate = useNavigate();
    const emailFromSignup = location.state?.email;

    const [email, setEmail] = useState(emailFromSignup || '');
    const [otp, setOtp] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [success, setSuccess] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        setSuccess('');
        try {
            const response = await axios.post('/auth/verify-otp', { email, otp });
            setSuccess(response.data.message || 'Verification successful! Redirecting...');
            setTimeout(() => {
                navigate('/login');
            }, 2000);
        } catch (err) {
            setError(err.response?.data?.message || 'OTP verification failed. Check your OTP or email.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10 bg-white p-8 border rounded-lg shadow-xl">
            <h2 className="text-3xl font-bold text-center mb-6 text-green-600">Verify Account</h2>
            <p className="text-center text-gray-500 mb-6">
                An OTP has been sent to your email address. Please enter it below.
            </p>

            {success && <div className="bg-green-100 text-green-700 p-3 rounded mb-4">{success}</div>}
            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}

            <form onSubmit={handleSubmit}>
                <div className="mb-4">
                    <label className="block text-gray-700">Email (must match signup email)</label>
                    <input 
                        type="email" 
                        value={email} 
                        onChange={(e) => setEmail(e.target.value)} 
                        required 
                        className="w-full p-2 border rounded" 
                        readOnly={!!emailFromSignup}
                    />
                </div>
                <div className="mb-6">
                    <label className="block text-gray-700">OTP Code</label>
                    <input 
                        type="text" 
                        value={otp} 
                        onChange={(e) => setOtp(e.target.value)} 
                        required 
                        maxLength="6"
                        className="w-full p-2 border text-center text-xl font-mono tracking-widest rounded"
                    />
                </div>
                <button type="submit" disabled={loading} className="btn-primary w-full disabled:opacity-50">
                    {loading ? 'Verifying...' : 'Verify Account'}
                </button>
            </form>
        </div>
    );
};

export default OtpVerification;

--- END FILE: shoppy-frontend\src\pages\OtpVerification.jsx ---

--- START FILE: shoppy-frontend\src\pages\SellerDashboard.jsx ---

import React, { useState, useEffect, useCallback } from 'react';
import axios from '../api/axiosInstance';
import { FaPlusSquare, FaEdit, FaStore } from 'react-icons/fa';

// --- Sub-Component: Add New Product Form ---
const AddProductForm = ({ onProductAdded }) => {
    const initialState = { name: '', description: '', price: '', stock: '', imageUrl: '' };
    const [formData, setFormData] = useState(initialState);
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [error, setError] = useState('');

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setMessage('');
        setError('');
        try {
            await axios.post('/seller/products', {
                ...formData,
                price: parseFloat(formData.price),
                stock: parseInt(formData.stock, 10),
            });
            setMessage('Product added successfully!');
            setFormData(initialState);
            onProductAdded(); // Trigger refresh in parent component
        } catch (err) {
            setError(err.response?.data?.message || 'Failed to add product.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="card mb-8">
            <h3 className="text-xl font-bold mb-4 flex items-center text-indigo-700">
                <FaPlusSquare className="mr-2" /> Add New Product
            </h3>
            {message && <div className="bg-green-100 text-green-700 p-3 rounded mb-4">{message}</div>}
            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}
            
            <form onSubmit={handleSubmit} className="grid grid-cols-2 gap-4">
                <input type="text" name="name" placeholder="Product Name" value={formData.name} onChange={handleChange} required className="col-span-2 p-2 border rounded" />
                <textarea name="description" placeholder="Description" value={formData.description} onChange={handleChange} className="col-span-2 p-2 border rounded" />
                <input type="number" name="price" placeholder="Price (e.g., 19.99)" value={formData.price} onChange={handleChange} required step="0.01" className="p-2 border rounded" />
                <input type="number" name="stock" placeholder="Stock Quantity" value={formData.stock} onChange={handleChange} required min="0" className="p-2 border rounded" />
                <input type="text" name="imageUrl" placeholder="Image URL (Optional)" value={formData.imageUrl} onChange={handleChange} className="col-span-2 p-2 border rounded" />
                
                <button type="submit" disabled={loading} className="btn-primary col-span-2 disabled:opacity-50">
                    {loading ? 'Submitting...' : 'Add Product'}
                </button>
            </form>
        </div>
    );
};

// --- Sub-Component: Product Management/Stock Update ---
const ProductManager = ({ products, fetchProducts }) => {
    const [editMode, setEditMode] = useState(null);
    const [editData, setEditData] = useState({});
    const [loadingUpdate, setLoadingUpdate] = useState(false);
    const [error, setError] = useState('');

    const handleEditClick = (product) => {
        setEditMode(product.id);
        setEditData({ 
            stock: product.stock, 
            price: product.price,
            name: product.name,
            description: product.description,
            imageUrl: product.imageUrl,
        });
        setError('');
    };
    
    const handleCancelEdit = () => {
        setEditMode(null);
        setError('');
    }

    const handleUpdate = async (productId) => {
        setLoadingUpdate(true);
        setError('');
        try {
            await axios.put(`/seller/products/${productId}`, {
                ...editData,
                price: parseFloat(editData.price),
                stock: parseInt(editData.stock, 10),
            });
            setEditMode(null);
            fetchProducts(); // Refresh list
        } catch (err) {
            setError(err.response?.data?.message || 'Failed to update product.');
        } finally {
            setLoadingUpdate(false);
        }
    };

    return (
        <div className="card">
            <h3 className="text-xl font-bold mb-4 flex items-center text-indigo-700">
                <FaStore className="mr-2" /> Current Inventory
            </h3>
             {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}

            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {products.map((product) => (
                        <tr key={product.id}>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {editMode === product.id ? (
                                    <input 
                                        type="text" 
                                        value={editData.name} 
                                        onChange={(e) => setEditData({...editData, name: e.target.value})}
                                        className="border p-1 w-24"
                                    />
                                ) : product.name}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {editMode === product.id ? (
                                    <input 
                                        type="number" 
                                        value={editData.price} 
                                        onChange={(e) => setEditData({...editData, price: e.target.value})}
                                        step="0.01" 
                                        className="border p-1 w-20"
                                    />
                                ) : `$${product.price}`}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {editMode === product.id ? (
                                    <input 
                                        type="number" 
                                        value={editData.stock} 
                                        onChange={(e) => setEditData({...editData, stock: e.target.value})}
                                        min="0" 
                                        className="border p-1 w-16"
                                    />
                                ) : product.stock}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                {editMode === product.id ? (
                                    <>
                                    <button 
                                        onClick={() => handleUpdate(product.id)}
                                        className="text-green-600 hover:text-green-900 disabled:opacity-50"
                                        disabled={loadingUpdate}
                                    >
                                        Save
                                    </button>
                                     <button 
                                        onClick={handleCancelEdit}
                                        className="text-gray-600 hover:text-gray-900"
                                    >
                                        Cancel
                                    </button>
                                    </>
                                ) : (
                                    <button 
                                        onClick={() => handleEditClick(product)}
                                        className="text-indigo-600 hover:text-indigo-900"
                                    >
                                        <FaEdit className="inline mr-1" /> Edit
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            {products.length === 0 && <p className="p-4 text-center text-gray-500">You have not added any products yet.</p>}
        </div>
    );
};


// --- Main Seller Dashboard Component ---
const SellerDashboard = () => {
    const [products, setProducts] = useState([]);
    const [loading, setLoading] = useState(true);
    // FIX APPLIED: Removed the entire destructuring line, resolving 'no-empty-pattern'
    // const { user } = useAuth(); // (Previously causing error)

    const fetchSellerProducts = useCallback(async () => {
        setLoading(true);
        try {
            // FIX: Call the dedicated Seller API endpoint
            const response = await axios.get('/seller/products'); 
            setProducts(response.data.data);
            
        } catch (error) {
            console.error("Failed to fetch seller products:", error);
        } finally {
            setLoading(false);
        }
    }, []); 

    useEffect(() => {
        fetchSellerProducts();
    }, [fetchSellerProducts]);

    if (loading) return <p className="text-center py-10">Loading inventory...</p>;

    return (
        <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-6">Seller Dashboard</h1>
            
            <AddProductForm onProductAdded={fetchSellerProducts} />
            
            <ProductManager products={products} fetchProducts={fetchSellerProducts} />
        </div>
    );
};

export default SellerDashboard;

--- END FILE: shoppy-frontend\src\pages\SellerDashboard.jsx ---

--- START FILE: shoppy-frontend\src\pages\Signup.jsx ---

import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import axios from '../api/axiosInstance';

const Signup = () => {
    const [formData, setFormData] = useState({ email: '', password: '', role: 'customer' });
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const navigate = useNavigate();

    const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            await axios.post('/auth/signup', formData);
            // Pass email to verification page for immediate use
            navigate('/verify-otp', { state: { email: formData.email } });
        } catch (err) {
            setError(err.response?.data?.message || 'Signup failed.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10 bg-white p-8 border rounded-lg shadow-xl">
            <h2 className="text-3xl font-bold text-center mb-6 text-indigo-600">Create Account</h2>
            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}
            <form onSubmit={handleSubmit}>
                <div className="mb-4">
                    <label className="block text-gray-700">Email</label>
                    <input type="email" name="email" value={formData.email} onChange={handleChange} required className="w-full p-2 border rounded" />
                </div>
                <div className="mb-4">
                    <label className="block text-gray-700">Password</label>
                    <input type="password" name="password" value={formData.password} onChange={handleChange} required className="w-full p-2 border rounded" />
                </div>
                <div className="mb-6">
                    <label className="block text-gray-700">Account Type</label>
                    <select name="role" value={formData.role} onChange={handleChange} className="w-full p-2 border rounded">
                        <option value="customer">Customer</option>
                        <option value="seller">Seller</option>
                    </select>
                </div>
                <button type="submit" disabled={loading} className="bg-indigo-600 text-white font-bold py-2 px-4 rounded w-full disabled:opacity-50">
                    {loading ? 'Signing Up...' : 'Sign Up'}
                </button>
            </form>
            <p className="mt-4 text-center"><Link to="/login" className="text-indigo-600 hover:underline">Already have an account?</Link></p>
        </div>
    );
};

export default Signup;

--- END FILE: shoppy-frontend\src\pages\Signup.jsx ---
